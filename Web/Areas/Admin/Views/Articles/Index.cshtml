@model List<Article>

@{
    ViewData["Title"] = "Articles";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Articles</h1>
        <a asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Article
        </a>
    </div>

    <!-- Search and Filter Section -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search by title, description, or slug...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="categoryFilter" class="form-select">
                        <option value="">All Categories</option>
                        <option value="Tech">Tech</option>
                        <option value="Business">Business</option>
                        <option value="Lifestyle">Lifestyle</option>
                        <option value="Health">Health</option>
                        <option value="Education">Education</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="statusFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="btn-group w-100">
                        <button class="btn btn-success" onclick="bulkActivate()">
                            <i class="fas fa-check"></i> Bulk Activate
                        </button>
                        <button class="btn btn-danger" onclick="bulkDelete()">
                            <i class="fas fa-trash"></i> Bulk Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <!-- Results info -->
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span id="resultsInfo" class="text-muted">Showing @Model.Count articles</span>
                <span class="text-muted small">
                    <input type="checkbox" id="selectAll" class="form-check-input me-1">
                    <label for="selectAll">Select All</label>
                </span>
            </div>

            <div class="table-responsive">
                <table class="table table-hover" id="articlesTable">
                    <thead class="table-primary">
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="selectAllHeader" class="form-check-input">
                            </th>
                            <th width="50">â‰¡</th>
                            <th width="80">Image</th>
                            <th>Title</th>
                            <th>Slug (SEO URL)</th>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Published</th>
                            <th width="200">Action</th>
                        </tr>
                    </thead>
                    <tbody id="sortableTable">
                        @foreach (var article in Model)
                        {
                            <tr data-id="@article.Id" class="article-row" 
                                data-title="@article.Title?.ToLower()" 
                                data-category="@article.Category" 
                                data-status="@(article.IsActive ? "active" : "inactive")"
                                data-slug="@article.Slug?.ToLower()"
                                data-description="@article.ShortDescription?.ToLower()">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input article-checkbox" value="@article.Id">
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-grip-vertical drag-handle" style="cursor: move;"></i>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(article.ImagePath))
                                    {
                                        <img src="@article.ImagePath" alt="@article.Title" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
                                    }
                                    else
                                    {
                                        <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    }
                                </td>
                                <td>
                                    <strong>@article.Title</strong>
                                    <br />
                                    <small class="text-muted">@article.ShortDescription?.Substring(0, Math.Min(80, article.ShortDescription?.Length ?? 0))...</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="text-muted small">/blog/@article.Slug</span>
                                        <button class="btn btn-sm btn-link" onclick="editSlug(@article.Id, '@article.Slug')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info">@article.Category</span>
                                </td>
                                <td>
                                    @if (article.IsActive)
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Inactive</span>
                                    }
                                </td>
                                <td>
                                    <small>@article.PublishedDate.ToString("dd MMM yyyy")</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a asp-action="Edit" asp-route-id="@article.Id" class="btn btn-warning" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn @(article.IsActive ? "btn-success" : "btn-secondary")" 
                                                title="@(article.IsActive ? "Active - Click to Deactivate" : "Inactive - Click to Activate")" 
                                                onclick="toggleStatus(@article.Id, @(article.IsActive ? "false" : "true"))">
                                            <i class="fas fa-@(article.IsActive ? "check-circle" : "times-circle")"></i>
                                        </button>
                                        <a href="/blog/@article.Slug" target="_blank" class="btn btn-info" title="Preview">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-danger" onclick="deleteArticle(@article.Id)" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- No results message -->
            <div id="noResults" class="text-center py-5" style="display: none;">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <p class="text-muted">No articles found matching your criteria.</p>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMessage"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = `toast align-items-center text-white border-0 bg-${type}`;
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Sortable functionality
        const table = document.getElementById('sortableTable');
        const sortable = Sortable.create(table, {
            handle: '.drag-handle',
            animation: 150,
            onEnd: function (evt) {
                updateSortOrder();
            }
        });

        function updateSortOrder() {
            const rows = document.querySelectorAll('#sortableTable tr.article-row');
            const sortData = [];

            rows.forEach((row, index) => {
                sortData.push({
                    id: parseInt(row.dataset.id),
                    sortOrder: index + 1
                });
            });

            fetch('@Url.Action("UpdateSortOrder")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify(sortData)
            })
            .then(response => {
                if (response.ok) {
                    showToast('Sort order updated successfully');
                }
            })
            .catch(error => {
                showToast('Error updating sort order', 'danger');
                console.error('Error:', error);
            });
        }

        // Search and Filter functionality
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const statusFilter = document.getElementById('statusFilter');
        const resultsInfo = document.getElementById('resultsInfo');
        const noResults = document.getElementById('noResults');

        function filterArticles() {
            const searchTerm = searchInput.value.toLowerCase();
            const category = categoryFilter.value;
            const status = statusFilter.value;
            const rows = document.querySelectorAll('.article-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const title = row.dataset.title || '';
                const slug = row.dataset.slug || '';
                const description = row.dataset.description || '';
                const rowCategory = row.dataset.category || '';
                const rowStatus = row.dataset.status || '';

                const matchesSearch = title.includes(searchTerm) || 
                                     slug.includes(searchTerm) || 
                                     description.includes(searchTerm);
                const matchesCategory = !category || rowCategory === category;
                const matchesStatus = !status || rowStatus === status;

                if (matchesSearch && matchesCategory && matchesStatus) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            resultsInfo.textContent = `Showing ${visibleCount} of ${rows.length} articles`;
            noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        }

        searchInput.addEventListener('input', filterArticles);
        categoryFilter.addEventListener('change', filterArticles);
        statusFilter.addEventListener('change', filterArticles);

        // Select All functionality
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.article-checkbox');
            checkboxes.forEach(cb => {
                if (cb.closest('tr').style.display !== 'none') {
                    cb.checked = this.checked;
                }
            });
        });

        document.getElementById('selectAllHeader').addEventListener('change', function() {
            document.getElementById('selectAll').checked = this.checked;
            document.getElementById('selectAll').dispatchEvent(new Event('change'));
        });

        // Bulk Operations
        function getSelectedIds() {
            const checkboxes = document.querySelectorAll('.article-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        function bulkActivate() {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                showToast('Please select articles to activate', 'warning');
                return;
            }

            if (confirm(`Activate ${ids.length} selected article(s)?`)) {
                Promise.all(ids.map(id => 
                    fetch('@Url.Action("ToggleStatus")?id=' + id + '&isActive=true', {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        }
                    })
                )).then(() => {
                    showToast(`${ids.length} article(s) activated successfully`);
                    setTimeout(() => location.reload(), 1000);
                }).catch(error => {
                    showToast('Error activating articles', 'danger');
                    console.error('Error:', error);
                });
            }
        }

        function bulkDelete() {
            const ids = getSelectedIds();
            if (ids.length === 0) {
                showToast('Please select articles to delete', 'warning');
                return;
            }

            if (confirm(`Are you sure you want to delete ${ids.length} selected article(s)?`)) {
                Promise.all(ids.map(id => 
                    fetch('@Url.Action("Delete")/' + id, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        }
                    })
                )).then(() => {
                    showToast(`${ids.length} article(s) deleted successfully`);
                    setTimeout(() => location.reload(), 1000);
                }).catch(error => {
                    showToast('Error deleting articles', 'danger');
                    console.error('Error:', error);
                });
            }
        }

        function editSlug(id, currentSlug) {
            const newSlug = prompt('Edit Slug:', currentSlug);
            if (newSlug && newSlug !== currentSlug) {
                fetch('@Url.Action("UpdateSlug")?id=' + id + '&slug=' + encodeURIComponent(newSlug), {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        showToast('Slug updated successfully');
                        setTimeout(() => location.reload(), 1000);
                    } else if (response.status === 409) {
                        showToast('Slug already exists', 'danger');
                    } else {
                        showToast('Error updating slug', 'danger');
                    }
                })
                .catch(error => {
                    showToast('Error updating slug', 'danger');
                    console.error('Error:', error);
                });
            }
        }

        function deleteArticle(id) {
            if (confirm('Are you sure you want to delete this article?')) {
                fetch('@Url.Action("Delete")/' + id, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        showToast('Article deleted successfully');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('Error deleting article', 'danger');
                    }
                })
                .catch(error => {
                    showToast('Error deleting article', 'danger');
                    console.error('Error:', error);
                });
            }
        }

        function toggleStatus(id, newStatus) {
            fetch('@Url.Action("ToggleStatus")?id=' + id + '&isActive=' + newStatus, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                }
            })
            .then(response => {
                if (response.ok) {
                    showToast('Status updated successfully');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Error updating status', 'danger');
                }
            })
            .catch(error => {
                showToast('Error updating status', 'danger');
                console.error('Error:', error);
            });
        }
    </script>
}
